<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Buscaminas - Sala {{ sala_id }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">
    <style>
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        body { font-family: 'Bungee', Arial, sans-serif; }
        h1, h2, button, #jugadores-lista {
            font-family: 'Bungee', Arial, sans-serif !important;
            letter-spacing: 1px;
        }
        button { 
            background: var(--button-bg); 
            color: var(--button-text); 
            border-radius: 7px; 
            border: none; 
            padding: 8px 24px; 
            margin: 8px; 
            font-size: 1.08em; 
            cursor: pointer; 
        }
        button:hover { background: var(--button-hover); }
        
        .sala-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--bg-panel);
            border-radius: 10px;
            border: 2px solid var(--accent);
        }
        
        .jugadores-panel {
            background: var(--bg-panel);
            border: 2px solid var(--accent);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            max-width: 300px;
        }
        
        .jugador {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            background: var(--cell-default);
        }
        
        .jugador-nombre {
            font-weight: bold;
        }
        
        .jugador-puntos {
            background: var(--accent);
            color: var(--button-text);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
        }
        
        .chat-panel {
            background: var(--bg-panel);
            border: 2px solid var(--accent);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            max-width: 300px;
            max-height: 200px;
        }
        
        .chat-messages {
            height: 120px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 5px;
            background: var(--bg-main);
            border-radius: 5px;
        }
        
        .chat-input {
            width: 100%;
            padding: 5px;
            border: 1px solid var(--accent);
            border-radius: 5px;
            background: var(--button-bg);
            color: var(--button-text);
        }
        
        .game-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .game-main {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .game-sidebar {
            width: 320px;
            flex-shrink: 0;
        }
        
        #contenedor-tablero {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 0 auto;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            border-radius: 16px;
            background: var(--bg-panel);
            position: relative;
        }
        
        .mensaje-sistema {
            color: var(--accent);
            font-style: italic;
            font-size: 0.9em;
        }
        
        .mensaje-jugador {
            color: var(--text-main);
            font-size: 0.9em;
        }
        
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .marcador {
            display: flex;
            gap: 12px;
            font-size: 0.85em;
            color: var(--accent);
            font-weight: bold;
            flex-wrap: wrap;
        }
        
        .controles {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .header-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .marcador {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <script>
        // Modo oscuro/claro universal solo lectura
        function aplicarModoOscuro() {
            document.body.classList.add("dark-mode");
        }
        function aplicarModoClaro() {
            document.body.classList.remove("dark-mode");
        }
        if (localStorage.getItem("modoOscuro") === "1") {
            aplicarModoOscuro();
        } else {
            aplicarModoClaro();
        }
    </script>
    
    <div class="sala-header">
        <h1>üß® Sala {{ sala_id }} üß®</h1>
        <div class="header-controls">
            <div class="marcador">
                <span>üéØ Celdas: <span id="celdas-descubiertas">0</span>/<span id="celdas-totales">0</span></span>
                <span>üö© Banderas: <span id="banderas-usadas">0</span>/<span id="minas-totales">0</span></span>
                <span>üí£ Minas restantes: <span id="minas-restantes">0</span></span>
            </div>
            <div class="controles">
                <span id="estado-sala">Esperando jugadores...</span>
                <span id="turno-actual" style="display:none; color: #4ecdc4; font-weight: bold;">üéØ Tu turno</span>
                <button id="btn-reiniciar" onclick="reiniciarJuego()" style="display:none;">üîÑ Reiniciar</button>
                <button onclick="window.location.href='/multijugador'">Salir</button>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="game-main">
            <div id="contenedor-tablero">
                <div id="tablero"></div>
            </div>
            <div id="mensaje"></div>
        </div>
        
        <div class="game-sidebar">
            <div class="jugadores-panel">
                <h3>üë• Jugadores</h3>
                <div id="jugadores-lista" data-jugadores="[]">
                    <!-- Aqu√≠ se mostrar√°n los jugadores -->
                </div>
            </div>
            
            <div class="chat-panel">
                <h3>üí¨ Chat</h3>
                <div id="chat-messages" class="chat-messages">
                    <div class="mensaje-sistema">Bienvenido a la sala!</div>
                </div>
                <input type="text" id="chat-input" class="chat-input" placeholder="Escribe un mensaje..." maxlength="100">
                <button onclick="enviarMensaje()">Enviar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io({
            transports: ['polling'],
            upgrade: false
        });
        const sala_id = '{{ sala_id }}';
        let miNombre = '';
        let miUUID = '';
        let tablero = [];
        let descubierto = [];
        let bandera = [];
        let filas = 0, columnas = 0;
        let minas = 0;
        let salaBloqueada = true;
        let numJugadores = 0;
        let soyCreador = false;
        let esMiTurno = false;
        let uuidActual = null;
        let mensajesMostrados = {
            anfitrion: false,
            salaDesbloqueada: false
        };
        
        function generarUUID() {
            if (crypto.randomUUID) {
                return crypto.randomUUID();
            } else {
                return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));
            }
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const nombreIngresado = urlParams.get('nombre');
        
        if (nombreIngresado) {
            miNombre = nombreIngresado;
        } else {
            miNombre = 'Jugador' + Math.floor(Math.random() * 1000);
        }
        
        miUUID = generarUUID();
        socket.emit('unirse_sala', { sala_id: sala_id, nombre: miNombre, uuid: miUUID });
        

        
        function crearTablero() {
            if (filas === 0 || columnas === 0) {
                return;
            }
            
            let t = "<table>";
            for (let f = 0; f < filas; f++) {
                t += "<tr>";
                for (let c = 0; c < columnas; c++) {
                    let contenido = "";
                    let clase = "";
                    let disabled = "";
                    
                    if (salaBloqueada || !esMiTurno) {
                        disabled = 'style="pointer-events:none;opacity:0.5;"';
                    }
                    
                    if (descubierto[f] && descubierto[f][c]) {
                        if (tablero[f] && tablero[f][c] === -1) {
                            contenido = '<img src="/static/bomba.gif" alt="üí£" style="width:40px; height:32px; margin-left:2px;">';
                        } else if (tablero[f] && typeof tablero[f][c] === "number" && tablero[f][c] > 0) {
                            contenido = tablero[f][c];
                        } else {
                            contenido = "";
                        }
                        clase = "descubierto";
                    } else if (bandera[f] && bandera[f][c]) {
                        contenido = "üö©";
                        clase = "bandera";
                    }
                    
                    t += `<td class="${clase}"
                        data-f="${f}" data-c="${c}"
                        onclick="descubrir(${f},${c})"
                        oncontextmenu="marcarBandera(event,${f},${c})"
                        ${disabled}>
                        ${contenido}
                    </td>`;
                }
                t += "</tr>";
            }
            t += "</table>";
            document.getElementById("tablero").innerHTML = t;
        }
        
        function mostrarModal(titulo, mensaje, callback = null) {
            const modal = document.getElementById('modal-fin');
            const emoji = document.getElementById('modal-emoji');
            const mensajeEl = document.getElementById('modal-mensaje');
            
            emoji.textContent = '‚ö†Ô∏è';
            mensajeEl.textContent = mensaje;
            modal.classList.remove('modal-oculto');
            modal.classList.add('modal-visible');
            
            if (callback) {
                setTimeout(callback, 100);
            }
        }
        
        function descubrir(f, c) {
            if (salaBloqueada) {
                mostrarModal('Sala Bloqueada', 'Espera a que se unan m√°s jugadores.');
                return;
            }
            if (!esMiTurno) {
                return;
            }
            socket.emit('accion_multijugador', {
                fila: f, columna: c, tipo: 'descubrir'
            });
        }
        
        function marcarBandera(e, f, c) {
            e.preventDefault();
            if (salaBloqueada) {
                mostrarModal('Sala Bloqueada', 'Espera a que se unan m√°s jugadores.');
                return;
            }
            if (!esMiTurno) {
                return;
            }
            socket.emit('accion_multijugador', {
                fila: f, columna: c, tipo: 'bandera'
            });
        }
        
        function mostrarModalTurno() {
            const modal = document.getElementById('modal-turno');
            modal.classList.remove('modal-oculto');
            modal.classList.add('modal-visible');
        }
        
        function cerrarModalTurno() {
            const modal = document.getElementById('modal-turno');
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-oculto');
        }
        
        function actualizarIndicadorTurno() {
            const turnoElement = document.getElementById('turno-actual');
            if (esMiTurno && !salaBloqueada) {
                turnoElement.style.display = 'inline';
                turnoElement.textContent = 'üéØ Tu turno';
                turnoElement.style.animation = 'pulse 1.5s infinite';
                
                // Mostrar modal de notificaci√≥n de turno
                mostrarModalTurno();
            } else {
                turnoElement.style.display = 'none';
                turnoElement.style.animation = 'none';
            }
        }
        
        function reiniciarJuego() {
            if (soyCreador) {
                socket.emit('reiniciar_juego');
            }
        }
        
        function enviarMensaje() {
            const input = document.getElementById('chat-input');
            const mensaje = input.value.trim();
            if (mensaje) {
                socket.emit('mensaje_chat', { mensaje: mensaje });
                input.value = '';
            }
        }
        
        function agregarMensajeChat(jugador, mensaje, esSistema = false) {
            const chatMessages = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = esSistema ? 'mensaje-sistema' : 'mensaje-jugador';
            div.textContent = esSistema ? mensaje : `${jugador}: ${mensaje}`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function actualizarMarcador() {
            let celdasDescubiertas = 0;
            let banderasUsadas = 0;
            
            for (let f = 0; f < filas; f++) {
                for (let c = 0; c < columnas; c++) {
                    if (descubierto[f][c]) celdasDescubiertas++;
                    if (bandera[f][c]) banderasUsadas++;
                }
            }
            
            const totalCeldas = filas * columnas;
            // Obtener el n√∫mero de minas del backend
            const totalMinas = obtenerNumeroMinas();
            
            const minasRestantes = totalMinas - banderasUsadas;
            
            document.getElementById('celdas-descubiertas').textContent = celdasDescubiertas;
            document.getElementById('celdas-totales').textContent = totalCeldas - totalMinas;
            document.getElementById('banderas-usadas').textContent = banderasUsadas;
            document.getElementById('minas-totales').textContent = totalMinas;
            document.getElementById('minas-restantes').textContent = minasRestantes;
        }
        
        function obtenerNumeroMinas() {
            // Usar el valor del backend si est√° disponible
            if (minas > 0) return minas;
            
            // Fallback basado en el nivel de dificultad
            if (filas === 8 && columnas === 8) return 10;  // F√°cil
            if (filas === 16 && columnas === 16) return 40; // Medio
            if (filas === 16 && columnas === 30) return 99; // Dif√≠cil
            return Math.floor((filas * columnas) * 0.15); // Estimaci√≥n para personalizado
        }
        
        function actualizarJugadores(jugadores) {
            const lista = document.getElementById('jugadores-lista');
            lista.innerHTML = '';
            
            if (!jugadores || !Array.isArray(jugadores)) {
                return;
            }
            
            jugadores.forEach(jugador => {
                const div = document.createElement('div');
                div.className = 'jugador';
                const esTurnoActual = jugador.uuid === uuidActual;
                div.innerHTML = `
                    <span class="jugador-nombre" style="color: ${jugador.color}">${jugador.nombre}</span>
                    <span class="jugador-estado">${esTurnoActual ? 'üéØ Su turno' : 'üü¢ Conectado'}</span>
                `;
                lista.appendChild(div);
            });
        }
        
        socket.on('jugador_unido', function(data) {
            agregarMensajeChat('', `${data.jugador} se uni√≥ a la sala`, true);
            actualizarJugadores(data.jugadores);
            numJugadores = data.jugadores.length;
            
            const miJugador = data.jugadores.find(j => j.nombre === miNombre);
            if (miJugador && miJugador.es_creador && !soyCreador) {
                soyCreador = true;
                if (!mensajesMostrados.anfitrion) {
                    agregarMensajeChat('', 'üëë Eres el anfitri√≥n de la sala', true);
                    mensajesMostrados.anfitrion = true;
                }
            }
            
            if (numJugadores >= 2 && salaBloqueada) {
                salaBloqueada = false;
                document.getElementById('estado-sala').textContent = '¬°Juego iniciado!';
                if (!mensajesMostrados.salaDesbloqueada) {
                    agregarMensajeChat('', 'üéÆ ¬°La sala se ha desbloqueado! El juego comienza por turnos.', true);
                    mensajesMostrados.salaDesbloqueada = true;
                }
                crearTablero();
            }
            
            socket.emit('solicitar_tablero');
        });
        
        socket.on('turno_asignado', function(data) {
            uuidActual = data.uuid_actual;
            esMiTurno = (miUUID === data.uuid_actual);
            
            agregarMensajeChat('', `üéØ ${data.jugador_actual} tiene el primer turno`, true);
            
            actualizarIndicadorTurno();
            actualizarJugadores(document.querySelector('#jugadores-lista').dataset.jugadores ? JSON.parse(document.querySelector('#jugadores-lista').dataset.jugadores) : []);
            crearTablero();
        });
        
        socket.on('actualizar_jugadores', function(data) {
            actualizarJugadores(data.jugadores);
            numJugadores = data.jugadores.length;
            
            document.querySelector('#jugadores-lista').dataset.jugadores = JSON.stringify(data.jugadores);
            
            if (numJugadores >= 2 && salaBloqueada) {
                salaBloqueada = false;
                document.getElementById('estado-sala').textContent = '¬°Juego iniciado!';
                if (!mensajesMostrados.salaDesbloqueada) {
                    agregarMensajeChat('', 'üéÆ ¬°La sala se ha desbloqueado! El juego comienza por turnos.', true);
                    mensajesMostrados.salaDesbloqueada = true;
                }
                socket.emit('solicitar_tablero');
            } else if (numJugadores < 2 && !salaBloqueada) {
                salaBloqueada = true;
                document.getElementById('estado-sala').textContent = 'Esperando jugadores...';
                esMiTurno = false;
                uuidActual = null;
                actualizarIndicadorTurno();
            }
            
            crearTablero();
        });
        
        socket.on('jugador_salio', function(data) {
            agregarMensajeChat('', `${data.jugador} sali√≥ de la sala`, true);
        });
        
        socket.on('celda_descubierta', function(data) {
            descubierto = data.descubierto;
            uuidActual = data.uuid_siguiente;
            esMiTurno = data.es_tu_turno;
            
            crearTablero();
            actualizarMarcador();
            actualizarIndicadorTurno();
            
            const totalCeldas = filas * columnas;
            const celdasSeguras = totalCeldas - minas;
            if (data.celdas_descubiertas >= celdasSeguras) {
                agregarMensajeChat('', 'üéâ ¬°VICTORIA DEL EQUIPO! ¬°Todos ganan!', true);
                salaBloqueada = true;
                document.getElementById('estado-sala').textContent = '¬°Victoria!';
                
                const modal = document.getElementById('modal-fin');
                const emoji = document.getElementById('modal-emoji');
                const mensaje = document.getElementById('modal-mensaje');
                
                emoji.textContent = 'üéâ';
                mensaje.textContent = '¬°VICTORIA DEL EQUIPO! ¬°Todos ganan!';
                modal.classList.remove('modal-oculto');
                modal.classList.add('modal-visible');
                
                if (soyCreador) {
                    document.getElementById('btn-reiniciar').style.display = 'inline-block';
                    document.getElementById('btn-reiniciar-modal').style.display = 'inline-block';
                }
            }
        });
        
        socket.on('mina_encontrada', function(data) {
            descubierto[data.fila][data.columna] = true;
            crearTablero();
            agregarMensajeChat('', `üí• ¬°BOOM! ${data.jugador} encontr√≥ una mina`, true);
            agregarMensajeChat('', 'üí• ¬°DERROTA DEL EQUIPO! Todos pierden', true);
            
            salaBloqueada = true;
            document.getElementById('estado-sala').textContent = '¬°Derrota!';
            
            const modal = document.getElementById('modal-fin');
            const emoji = document.getElementById('modal-emoji');
            const mensaje = document.getElementById('modal-mensaje');
            
            emoji.textContent = 'üí•';
            mensaje.textContent = '¬°DERROTA DEL EQUIPO! Todos pierden';
            modal.classList.remove('modal-oculto');
            modal.classList.add('modal-visible');
            
            if (soyCreador) {
                document.getElementById('btn-reiniciar').style.display = 'inline-block';
                document.getElementById('btn-reiniciar-modal').style.display = 'inline-block';
            } else {
                mensaje.textContent = '¬°DERROTA DEL EQUIPO! Esperando al anfitri√≥n...';
            }
        });
        
        socket.on('bandera_marcada', function(data) {
            bandera[data.fila][data.columna] = data.marcada;
            uuidActual = data.uuid_siguiente;
            esMiTurno = data.es_tu_turno;
            
            crearTablero();
            actualizarMarcador();
            actualizarIndicadorTurno();
        });
        
        socket.on('datos_tablero', function(data) {
            tablero = data.tablero;
            descubierto = data.descubierto;
            bandera = data.bandera;
            filas = data.filas;
            columnas = data.columnas;
            minas = data.minas || 0;
            
            esMiTurno = data.es_tu_turno || false;
            uuidActual = data.uuid_actual || null;
            actualizarIndicadorTurno();
            
            crearTablero();
            actualizarMarcador();
        });
        
        socket.on('mensaje_chat', function(data) {
            agregarMensajeChat(data.jugador, data.mensaje);
        });
        
        // Enviar mensaje con Enter
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                enviarMensaje();
            }
        });
        
        socket.on('connect', function() {
            console.log('Conectado al servidor');
        });
        
        socket.on('error_turno', function(data) {
            console.log('Error de turno:', data);
            mostrarModal('No es tu turno', data.mensaje);
        });
        
        socket.on('disconnect', function() {
            console.log('Desconectado del servidor');
        });
        
        socket.on('juego_reiniciado', function(data) {
            tablero = data.tablero;
            descubierto = data.descubierto;
            bandera = data.bandera;
            salaBloqueada = false;
            uuidActual = null;
            mensajesMostrados = {
                anfitrion: false,
                salaDesbloqueada: false
            };
            document.getElementById('estado-sala').textContent = '¬°Juego reiniciado!';
            document.getElementById('btn-reiniciar').style.display = 'none';
            document.getElementById('btn-reiniciar-modal').style.display = 'none';
            document.getElementById('modal-fin').classList.remove('modal-visible');
            document.getElementById('modal-fin').classList.add('modal-oculto');
            crearTablero();
            actualizarMarcador();
            agregarMensajeChat('', 'üîÑ El juego ha sido reiniciado', true);
        });
    </script>
    

    
    <!-- Modal de fin de juego -->
    <div id="modal-fin" class="modal-oculto">
        <div class="modal-contenido">
            <span id="modal-emoji" style="font-size:2.5em;"></span>
            <h2 id="modal-mensaje"></h2>
            <button id="btn-reiniciar-modal" onclick="reiniciarJuego()" style="display:none;">üîÑ Reiniciar Juego</button>
            <button onclick="window.location.href='/multijugador'">Salir</button>
        </div>
    </div>

    <!-- Modal de notificaci√≥n de turno -->
    <div id="modal-turno" class="modal-oculto">
        <div class="modal-contenido" style="max-width: 400px;">
            <span style="font-size:3em;">üéØ</span>
            <h2 id="modal-turno-mensaje">¬°Es tu turno!</h2>
            <p id="modal-turno-descripcion">Toca una celda para descubrir o marca una bandera</p>
            <button onclick="cerrarModalTurno()" style="background: #4ecdc4; color: white;">¬°Entendido!</button>
        </div>
    </div>
</body>
</html> 