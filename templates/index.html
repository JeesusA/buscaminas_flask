<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Buscaminas Flask</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body data-filas="{{ filas }}" data-columnas="{{ columnas }}" data-minas="{{ minas }}" data-nivel="{{ nivel }}">
    <h1>üß® Buscaminas üß®</h1>
    <div id="contador-banderas" style="font-size:1.2em; margin-bottom:4px; color:#ffd978;">Banderas restantes: <span id="banderas-restantes"></span></div>
    <div id="temporizador" style="font-size:1.2em; margin-bottom:8px; color:#ffd978;">
        Tiempo: <span id="tiempo-juego">0</span> s
        <span id="record-tiempo" style="margin-left:16px; font-size:0.95em; color:#fff; background:#203057; border-radius:6px; padding:2px 10px;">R√©cord: <span id="mejor-tiempo">--</span> s</span>
        <button id="borrar-record" style="margin-left:10px; font-size:0.8em; background:#b70000; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">Borrar r√©cord</button>
    </div>
    <button onclick="window.location.href='/'">Men√∫ principal</button>
    <button id="btn-nuevo-juego">Nuevo juego</button>
    <div id="contenedor-tablero">
        <div id="tablero"></div>
    </div>
    <div id="scroll-hint">‚áÜ Desliza para ver todo el tablero</div>
    <div id="mensaje"></div>

    <!-- Modal de fin de juego -->
    <div id="modal-fin" class="modal-oculto">
        <div class="modal-contenido">
            <span id="modal-emoji" style="font-size:2.5em;"></span>
            <h2 id="modal-mensaje"></h2>
            <button onclick="location.reload()">Nuevo juego</button>
            <button onclick="window.location.href='/'">Men√∫ principal</button>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n de reinicio -->
    <div id="modal-reinicio" class="modal-oculto">
        <div class="modal-contenido">
            <span style="font-size:2.2em;">‚ö†Ô∏è</span>
            <h2>¬øSeguro que quieres reiniciar la partida?</h2>
            <p>Se perder√° el progreso actual.</p>
            <button id="btn-confirmar-reinicio">S√≠, reiniciar</button>
            <button id="btn-cancelar-reinicio">Cancelar</button>
        </div>
    </div>

    <script>
        const filas = parseInt(document.body.dataset.filas);
        const columnas = parseInt(document.body.dataset.columnas);
        const minas = parseInt(document.body.dataset.minas);
        const nivel = document.body.dataset.nivel;
        let descubierto = Array.from({length: filas}, () => Array(columnas).fill(false));
        let bandera = Array.from({length: filas}, () => Array(columnas).fill(false));
        let tablero = Array.from({length: filas}, () => Array(columnas).fill(""));

        // Para soporte de long press en m√≥vil
        let longPressTimer = null;
        let longPressTriggered = false;

        let timer = null;
        let tiempo = 0;
        let juegoIniciado = false;
        let juegoTerminado = false;
        function iniciarTemporizador() {
            if (timer !== null) return;
            timer = setInterval(() => {
                tiempo++;
                document.getElementById("tiempo-juego").textContent = tiempo;
            }, 1000);
        }
        function detenerTemporizador() {
            if (timer !== null) {
                clearInterval(timer);
                timer = null;
            }
        }

        function actualizarContadorBanderas() {
            let usadas = 0;
            for (let f = 0; f < filas; f++) {
                for (let c = 0; c < columnas; c++) {
                    if (bandera[f][c]) usadas++;
                }
            }
            document.getElementById("banderas-restantes").textContent = minas - usadas;
        }

        function crearTablero(descubierto, bandera, tablero, fin, celdaExplotada=null, ganaste=false) {
            let t = "<table>";
            for (let f = 0; f < filas; f++) {
                t += "<tr>";
                for (let c = 0; c < columnas; c++) {
                    let contenido = "";
                    let clase = "";
                    if (descubierto[f][c]) {
                        if (tablero[f][c] === -1) {
                            contenido = ganaste ? "üèÅ" : "üí£";
                        } else if (typeof tablero[f][c] === "number" && tablero[f][c] > 0) {
                            contenido = tablero[f][c];
                        } else {
                            contenido = "";
                        }
                        clase = "descubierto";
                        if (celdaExplotada && f === celdaExplotada[0] && c === celdaExplotada[1]) {
                            clase += " celda-explotada";
                        }
                    } else if (bandera[f][c]) {
                        contenido = "üö©";
                        clase = "bandera";
                    } else if (fin && tablero[f][c] === -1) {
                        // Mostrar minas no descubiertas al final
                        contenido = ganaste ? "üèÅ" : "üí£";
                        clase = "descubierto extra-mina";
                    }
                    t += `<td class="${clase}"
                        onclick="descubrir(${f},${c})"
                        oncontextmenu="marcarBandera(event,${f},${c})"
                        ontouchstart="iniciarLongPress(event,${f},${c})"
                        ontouchend="cancelarLongPress(event)"
                        ontouchmove="cancelarLongPress(event)">
                        ${contenido}
                    </td>`;
                }
                t += "</tr>";
            }
            t += "</table>";
            document.getElementById("tablero").innerHTML = t;
            actualizarContadorBanderas();
        }

        function descubrir(f, c) {
            if (juegoTerminado) return;
            if (!juegoIniciado) {
                iniciarTemporizador();
                juegoIniciado = true;
            }
            movimientos++;
            if (longPressTriggered) {
                longPressTriggered = false;
                return;
            }
            if (descubierto[f][c]) return;
            const modal = document.getElementById('modal-fin');
            if (modal.classList.contains('modal-visible')) return;
            fetch('/accion', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({fila: f, columna: c, tipo: "descubrir"})
            }).then(r => r.json()).then(res => {
                descubierto = res.descubierto;
                bandera = res.bandera;
                if (res.tablero) tablero = res.tablero;
                if (res.fin) {
                    if (res.perdiste) {
                        crearTablero(descubierto, bandera, tablero, true, [f, c], false);
                    } else {
                        crearTablero(descubierto, bandera, tablero, true, null, true);
                    }
                    detenerTemporizador();
                    setTimeout(function() {
                        mostrarModal(res.ganaste);
                        if (res.ganaste) {
                            fetch('/record', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({nivel: nivel})});
                        }
                    }, 1000);
                    // Aseguro que juegoIniciado se marque como false al finalizar
                    juegoIniciado = false;
                    juegoTerminado = true;
                } else {
                    crearTablero(descubierto, bandera, tablero, false);
                }
            }).catch(() => {
                mostrarModal(null, true);
            });
        }
        function marcarBandera(e, f, c) {
            if (juegoTerminado) return;
            if (!juegoIniciado) {
                iniciarTemporizador();
                juegoIniciado = true;
            }
            movimientos++;
            if (e) e.preventDefault();
            fetch('/accion', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({fila: f, columna: c, tipo: "bandera"})
            }).then(r => r.json()).then(res => {
                descubierto = res.descubierto;
                bandera = res.bandera;
                crearTablero(descubierto, bandera, tablero, res.fin);
            }).catch(() => {
                mostrarModal(null, true);
            });
        }
        // Soporte long press m√≥vil
        function iniciarLongPress(e, f, c) {
            longPressTriggered = false;
            longPressTimer = setTimeout(function() {
                longPressTriggered = true;
                marcarBandera(null, f, c);
            }, 500); // 500ms para long press
        }
        function cancelarLongPress(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        function mostrarRecord() {
            let record = localStorage.getItem("record_" + nivel);
            if (record !== null) {
                document.getElementById("mejor-tiempo").textContent = record;
            } else {
                document.getElementById("mejor-tiempo").textContent = "--";
            }
        }
        function mostrarModal(ganaste, error=false) {
            const modal = document.getElementById('modal-fin');
            const emoji = document.getElementById('modal-emoji');
            const mensaje = document.getElementById('modal-mensaje');
            if (error) {
                emoji.textContent = '‚ö†Ô∏è';
                mensaje.textContent = 'Ocurri√≥ un error inesperado.';
            } else if (ganaste) {
                emoji.textContent = 'ü•≥';
                mensaje.textContent = '¬°Felicidades! ¬°Ganaste!';
                // Actualizar r√©cord si es mejor y nunca guardar 0
                let record = localStorage.getItem("record_" + nivel);
                let tiempoValido = (tiempo === 0) ? 1 : tiempo;
                if (record === null || tiempoValido < parseInt(record)) {
                    localStorage.setItem("record_" + nivel, tiempoValido);
                    document.getElementById("mejor-tiempo").textContent = tiempoValido;
                    mensaje.textContent += `\n¬°Nuevo r√©cord! üèÜ`;
                }
            } else {
                emoji.textContent = 'üí£';
                mensaje.textContent = '¬°BOOM! Explotaste we';
            }
            modal.classList.remove('modal-oculto');
            modal.classList.add('modal-visible');
            detenerTemporizador();
        }
        window.onload = function() {
            crearTablero(descubierto, bandera, tablero, false);
            actualizarContadorBanderas();
            document.getElementById("tiempo-juego").textContent = 0;
            tiempo = 0;
            juegoIniciado = false;
            juegoTerminado = false;
            detenerTemporizador();
            movimientos = 0;
            mostrarRecord();
            document.getElementById("btn-nuevo-juego").onclick = function() {
                if (movimientos > 0) {
                    mostrarModalReinicio();
                } else {
                    location.reload();
                }
            };
            document.getElementById("btn-confirmar-reinicio").onclick = function() {
                location.reload();
            };
            document.getElementById("btn-cancelar-reinicio").onclick = function() {
                ocultarModalReinicio();
            };
            document.getElementById("borrar-record").onclick = function() {
                localStorage.removeItem("record_" + nivel);
                mostrarRecord();
            };
            // Agrego estilos para resaltar la celda explotada y minas extra
            const style = document.createElement('style');
            style.innerHTML = `.celda-explotada { background: #b70000 !important; color: #fff !important; animation: none !important; }
            .extra-mina { opacity: 0.7; }`;
            document.head.appendChild(style);
        }
        function mostrarModalReinicio() {
            const modal = document.getElementById('modal-reinicio');
            modal.classList.remove('modal-oculto');
            modal.classList.add('modal-visible');
        }
        function ocultarModalReinicio() {
            const modal = document.getElementById('modal-reinicio');
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-oculto');
        }
    </script>
</body>
</html>
