<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Buscaminas Flask</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .resaltada { box-shadow: 0 0 0 3px var(--accent) !important; z-index: 2; }
        .adyacente { box-shadow: 0 0 0 2px var(--accent)55 !important; z-index: 1; }
        .bomba-perdida { background: #b70000 !important; color: #fff !important; border: 2.5px solid #b70000 !important; animation: none !important; }
        .celda-explotada { background: #7a001a !important; color: #fff !important; border: 2.5px solid #b70000 !important; animation: none !important; }
    </style>
</head>
<body data-filas="{{ filas }}" data-columnas="{{ columnas }}" data-minas="{{ minas }}" data-nivel="{{ nivel }}">
    <script>
        // Modo oscuro/claro universal solo lectura (antes de cualquier renderizado visual)
        function aplicarModoOscuro() {
            document.body.classList.add("dark-mode");
        }
        function aplicarModoClaro() {
            document.body.classList.remove("dark-mode");
        }
        if (localStorage.getItem("modoOscuro") === "1") {
            aplicarModoOscuro();
        } else {
            aplicarModoClaro();
        }
    </script>
    <h1>üß® Buscaminas üß®</h1>
    <div id="contador-banderas" style="font-size:1.2em; margin-bottom:4px; color:var(--accent);">Banderas restantes: <span id="banderas-restantes"></span></div>
    <div id="temporizador" style="font-size:1.2em; margin-bottom:8px; color:var(--accent);">
        <span id="texto-tiempo"></span>
        <span id="tiempo-juego">0</span> s
        <span id="record-tiempo" style="margin-left:16px; font-size:0.95em; color:#fff; background:#203057; border-radius:6px; padding:2px 10px;">R√©cord: <span id="mejor-tiempo">--</span> s</span>
        <button id="borrar-record" style="margin-left:10px; font-size:0.8em; background:#b70000; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">Borrar r√©cord</button>
    </div>
    <div style="margin-bottom: 12px;">
        <button onclick="window.location.href='/'">Men√∫ principal</button>
        <button id="btn-nuevo-juego">Nuevo juego</button>
    </div>
    <!-- Elimino el bot√≥n y mensaje de guardar partida -->
    <div id="contenedor-tablero">
        <div id="tablero"></div>
    </div>
    <div id="scroll-hint">‚áÜ Desliza para ver todo el tablero</div>
    <div id="mensaje"></div>
    <!-- Elimino el contador y mensaje de mina m√≥vil -->

    <!-- Modal de fin de juego -->
    <div id="modal-fin" class="modal-oculto">
        <div class="modal-contenido">
            <span id="modal-emoji" style="font-size:2.5em;"></span>
            <h2 id="modal-mensaje"></h2>
            <button onclick="location.reload()">Nuevo juego</button>
            <button onclick="window.location.href='/'">Men√∫ principal</button>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n de reinicio -->
    <div id="modal-reinicio" class="modal-oculto">
        <div class="modal-contenido">
            <span style="font-size:2.2em;">‚ö†Ô∏è</span>
            <h2>¬øSeguro que quieres reiniciar la partida?</h2>
            <p>Se perder√° el progreso actual.</p>
            <button id="btn-confirmar-reinicio">S√≠, reiniciar</button>
            <button id="btn-cancelar-reinicio">Cancelar</button>
        </div>
    </div>

    <!-- Elimino el modal de continuar partida -->

    <script>
        const modo = "{{ modo|default('clasico') }}";
        const filas = parseInt(document.body.dataset.filas);
        const columnas = parseInt(document.body.dataset.columnas);
        const minas = parseInt(document.body.dataset.minas);
        const nivel = document.body.dataset.nivel;
        let descubierto = Array.from({length: filas}, () => Array(columnas).fill(false));
        let bandera = Array.from({length: filas}, () => Array(columnas).fill(false));
        let tablero = Array.from({length: filas}, () => Array(columnas).fill(""));

        // Para soporte de long press en m√≥vil
        let longPressTimer = null;
        let longPressTriggered = false;

        let timer = null;
        let tiempo = 0;
        let tiempoRestante = parseInt('{{ tiempo_limite|default(60) }}'); // Tiempo l√≠mite din√°mico para contrarreloj
        let juegoIniciado = false;
        let juegoTerminado = false;
        function iniciarTemporizador() {
            if (timer !== null) return;
            if (modo === 'contrarreloj') {
                document.getElementById('texto-tiempo').textContent = 'Tiempo restante: ';
                document.getElementById('tiempo-juego').textContent = tiempoRestante;
                timer = setInterval(() => {
                    tiempoRestante--;
                    document.getElementById('tiempo-juego').textContent = tiempoRestante;
                    if (tiempoRestante <= 0) {
                        detenerTemporizador();
                        mostrarModal(null, true, '¬°Se acab√≥ el tiempo!');
                    }
                }, 1000);
            } else {
                document.getElementById('texto-tiempo').textContent = 'Tiempo: ';
                timer = setInterval(() => {
                    tiempo++;
                    document.getElementById('tiempo-juego').textContent = tiempo;
                }, 1000);
            }
        }
        function detenerTemporizador() {
            if (timer !== null) {
                clearInterval(timer);
                timer = null;
            }
        }

        function actualizarContadorBanderas() {
            let usadas = 0;
            for (let f = 0; f < filas; f++) {
                for (let c = 0; c < columnas; c++) {
                    if (bandera[f][c]) usadas++;
                }
            }
            document.getElementById("banderas-restantes").textContent = minas - usadas;
        }

        // Variables para animaci√≥n de celda
        let ultimaDescubierta = null;
        let ultimaBandera = null;

        function crearTablero(descubierto, bandera, tablero, fin, celdaExplotada=null, ganaste=false) {
            let t = "<table>";
            for (let f = 0; f < filas; f++) {
                t += "<tr>";
                for (let c = 0; c < columnas; c++) {
                    let contenido = "";
                    let clase = "";
                    let disabled = "";
                    if (descubierto[f][c]) {
                        if (tablero[f][c] === -1) {
                            contenido = ganaste ? "üèÅ" : "üí£";
                        } else if (typeof tablero[f][c] === "number" && tablero[f][c] > 0) {
                            contenido = tablero[f][c];
                        } else {
                            contenido = "";
                        }
                        clase = "descubierto";
                        if (ultimaDescubierta && f === ultimaDescubierta.f && c === ultimaDescubierta.c) {
                            clase += " animar-pop";
                        }
                        if (celdaExplotada && f === celdaExplotada[0] && c === celdaExplotada[1]) {
                            clase += " celda-explotada";
                        }
                    } else if (bandera[f][c]) {
                        contenido = "üö©";
                        clase = "bandera";
                        if (ultimaBandera && f === ultimaBandera.f && c === ultimaBandera.c) {
                            clase += " animar-flag";
                        }
                    } else if (fin && tablero[f][c] === -1) {
                        contenido = ganaste ? "üèÅ" : "üí£";
                        clase = "descubierto bomba-perdida";
                    }
                    // Tutorial: solo permite clic en la celda indicada
                    // if (esTutorial && pasoTutorial === 0 && (f !== celdaTutorial.f || c !== celdaTutorial.c)) {
                    //     disabled = 'style="pointer-events:none;opacity:0.5;"';
                    // }
                    // if (esTutorial && pasoTutorial === 0 && f === celdaTutorial.f && c === celdaTutorial.c) {
                    //     clase += " resaltada";
                    // }
                    t += `<td class="${clase}"
                        data-f="${f}" data-c="${c}"
                        onclick="descubrir(${f},${c})"
                        oncontextmenu="marcarBandera(event,${f},${c})"
                        ontouchstart="iniciarLongPress(event,${f},${c})"
                        ontouchend="cancelarLongPress(event)"
                        ontouchmove="cancelarLongPress(event)"
                        onmouseover="resaltarCeldas(${f},${c})"
                        onmouseout="quitarResaltado()" ${disabled}>
                        ${contenido}
                    </td>`;
                }
                t += "</tr>";
            }
            t += "</table>";
            document.getElementById("tablero").innerHTML = t;
            actualizarContadorBanderas();
            // Limpio la animaci√≥n despu√©s de un ciclo
            setTimeout(() => { ultimaDescubierta = null; ultimaBandera = null; }, 350);
        }

        // Defino descubrir en window si no existe
        if (!window.descubrir) {
            window.descubrir = function(f, c) {
                if (juegoTerminado) return;
                if (!juegoIniciado) {
                    iniciarTemporizador();
                    juegoIniciado = true;
                }
                movimientos++;
                if (longPressTriggered) {
                    longPressTriggered = false;
                    return;
                }
                if (descubierto[f][c]) return;
                const modal = document.getElementById('modal-fin');
                if (modal.classList.contains('modal-visible')) return;
                fetch('/accion', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({fila: f, columna: c, tipo: "descubrir"})
                }).then(r => r.json()).then(res => {
                    descubierto = res.descubierto;
                    bandera = res.bandera;
                    if (res.tablero) tablero = res.tablero;
                    // Elimino la funci√≥n guardarPartida y cualquier llamada a ella
                    if (res.fin) {
                        if (res.perdiste) {
                            crearTablero(descubierto, bandera, tablero, true, [f, c], false);
                        } else {
                            crearTablero(descubierto, bandera, tablero, true, null, true);
                        }
                        detenerTemporizador();
                        setTimeout(function() {
                            mostrarModal(res.ganaste);
                            if (res.ganaste) {
                                fetch('/record', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({nivel: nivel})});
                            }
                        }, 1000);
                        // Aseguro que juegoIniciado se marque como false al finalizar
                        juegoIniciado = false;
                        juegoTerminado = true;
                    } else {
                        crearTablero(descubierto, bandera, tablero, false);
                    }
                }).catch(() => {
                    mostrarModal(null, true);
                });
            }
        }
        // Modifico descubrir y marcarBandera para animar solo la celda seleccionada
        const descubrirOriginal = window.descubrir;
        window.descubrir = function(f, c) {
            movimientos++;
            ultimaDescubierta = {f, c};
            descubrirOriginal(f, c);
        }
        // Defino window.marcarBandera si no existe
        if (!window.marcarBandera) {
            window.marcarBandera = function(e, f, c) {
                if (juegoTerminado) return;
                if (!juegoIniciado) {
                    iniciarTemporizador();
                    juegoIniciado = true;
                }
                movimientos++;
                if (e) e.preventDefault();
                fetch('/accion', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({fila: f, columna: c, tipo: "bandera"})
                }).then(r => r.json()).then(res => {
                    descubierto = res.descubierto;
                    bandera = res.bandera;
                    // Elimino la funci√≥n guardarPartida y cualquier llamada a ella
                    crearTablero(descubierto, bandera, tablero, res.fin);
                }).catch(() => {
                    mostrarModal(null, true);
                });
            }
        }
        // Modifico marcarBandera para deshabilitar en modo sin banderas
        const marcarBanderaOriginal = window.marcarBandera;
        window.marcarBandera = function(e, f, c) {
            if (modo === 'sinbanderas') {
                if (e) e.preventDefault();
                document.getElementById('mensaje').textContent = 'No puedes marcar banderas en este modo.';
                setTimeout(() => { document.getElementById('mensaje').textContent = ''; }, 1500);
                return;
            }
            ultimaBandera = {f, c};
            marcarBanderaOriginal(e, f, c);
        }
        // Soporte long press m√≥vil
        function iniciarLongPress(e, f, c) {
            longPressTriggered = false;
            longPressTimer = setTimeout(function() {
                longPressTriggered = true;
                marcarBandera(null, f, c);
            }, 500); // 500ms para long press
        }
        function cancelarLongPress(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        function mostrarRecord() {
            let record = localStorage.getItem("record_" + nivel);
            if (record !== null) {
                document.getElementById("mejor-tiempo").textContent = record;
            } else {
                document.getElementById("mejor-tiempo").textContent = "--";
            }
        }
        function mostrarModal(ganaste, error=false, mensajeExtra=null) {
            const modal = document.getElementById('modal-fin');
            const emoji = document.getElementById('modal-emoji');
            const mensaje = document.getElementById('modal-mensaje');
            if (error) {
                emoji.textContent = '‚ö†Ô∏è';
                mensaje.textContent = mensajeExtra || 'Ocurri√≥ un error inesperado.';
            } else if (ganaste) {
                emoji.textContent = 'ü•≥';
                mensaje.textContent = '¬°Felicidades! ¬°Ganaste!';
                // Actualizar r√©cord si es mejor y nunca guardar 0
                let record = localStorage.getItem("record_" + nivel);
                let tiempoValido = (tiempo === 0) ? 1 : tiempo;
                if (record === null || tiempoValido < parseInt(record)) {
                    localStorage.setItem("record_" + nivel, tiempoValido);
                    document.getElementById("mejor-tiempo").textContent = tiempoValido;
                    mensaje.textContent += `\n¬°Nuevo r√©cord! üèÜ`;
                }
            } else {
                emoji.textContent = 'üí£';
                mensaje.textContent = '¬°BOOM! Explotaste we';
            }
            modal.classList.remove('modal-oculto');
            modal.classList.add('modal-visible');
            detenerTemporizador();
        }
        // Elimino la l√≥gica de mina m√≥vil en descubrir y moverMina
        window.onload = function() {
            // Elimino la l√≥gica de restaurar partida en window.onload
            crearTablero(descubierto, bandera, tablero, false);
            actualizarContadorBanderas();
            if (modo === 'contrarreloj') {
                tiempoRestante = parseInt('{{ tiempo_limite|default(60) }}');
                document.getElementById('texto-tiempo').textContent = 'Tiempo restante: ';
                document.getElementById('tiempo-juego').textContent = tiempoRestante;
            } else {
                document.getElementById('texto-tiempo').textContent = 'Tiempo: ';
                document.getElementById('tiempo-juego').textContent = 0;
            }
            tiempo = 0;
            juegoIniciado = false;
            juegoTerminado = false;
            detenerTemporizador();
            movimientos = 0;
            document.getElementById('mina-movil-info').style.display = 'none';
            mostrarRecord();
            document.getElementById("btn-nuevo-juego").onclick = function() {
                if (movimientos > 0) {
                    mostrarModalReinicio();
                } else {
                    location.reload();
                }
            };
            document.getElementById("btn-confirmar-reinicio").onclick = function() {
                location.reload();
            };
            document.getElementById("btn-cancelar-reinicio").onclick = function() {
                ocultarModalReinicio();
            };
            document.getElementById("borrar-record").onclick = function() {
                localStorage.removeItem("record_" + nivel);
                mostrarRecord();
            };
            // Agrego estilos para resaltar la celda explotada y minas extra
            const style = document.createElement('style');
            style.innerHTML = `.celda-explotada { background: #b70000 !important; color: #fff !important; animation: none !important; }
            .extra-mina { opacity: 0.7; }`;
            document.head.appendChild(style);

            // Elimino la funci√≥n encontrarCeldaSegura, la l√≥gica de pistas y el contador de pistas
        }
        function mostrarModalReinicio() {
            const modal = document.getElementById('modal-reinicio');
            modal.classList.remove('modal-oculto');
            modal.classList.add('modal-visible');
        }
        function ocultarModalReinicio() {
            const modal = document.getElementById('modal-reinicio');
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-oculto');
        }
        // Resaltado de celdas adyacentes
        function resaltarCeldas(f, c) {
            quitarResaltado();
            const tabla = document.getElementById("tablero");
            const celdas = tabla.getElementsByTagName("td");
            for (let i = 0; i < celdas.length; i++) {
                let cf = parseInt(celdas[i].getAttribute("data-f"));
                let cc = parseInt(celdas[i].getAttribute("data-c"));
                if (cf === f && cc === c) {
                    celdas[i].classList.add("resaltada");
                } else if (Math.abs(cf - f) <= 1 && Math.abs(cc - c) <= 1) {
                    celdas[i].classList.add("adyacente");
                }
            }
        }
        function quitarResaltado() {
            const tabla = document.getElementById("tablero");
            const celdas = tabla.getElementsByTagName("td");
            for (let i = 0; i < celdas.length; i++) {
                celdas[i].classList.remove("resaltada");
                celdas[i].classList.remove("adyacente");
            }
        }
    </script>
</body>
</html>
